# 專案架構及程式碼分析

## 1. 專案概述 (Project Overview)

本專案是一個基於 **Electron** 和 **Vue.js 2** 的桌面應用程式，主要用於工業自動化控制系統（MMS/EV）。它透過 **Modbus TCP** 協定與 PLC（可程式邏輯控制器）進行通訊，監控感測器數值並控制機器手臂與幫浦等設備。

-   **核心框架**: Electron (v13.0.0)
-   **前端框架**: Vue.js (v2.6.14)
-   **UI 元件庫**: Vuetify (v2.6.0)
-   **通訊協定**: Modbus TCP (使用 `jsmodbus`)
-   **狀態管理**: Vue EventBus + Local State
-   **構建工具**: vue-cli-service + electron-builder

---

## 2. 目錄結構 (Directory Structure)

```
wesolutions_mms_ev-test/
├── dist_electron/          # Electron 構建輸出目錄
├── public/                 # 靜態資源 (icon, index.html)
├── src/                    # 原始碼目錄
│   ├── assets/             # 圖片與樣式資源
│   ├── components/         # Vue 元件 (功能模組)
│   │   ├── DockServer.vue      # 伺服器架控制
│   │   ├── IssueReport.vue     # 事件回報列表
│   │   ├── MainFunction.vue    # 主要功能 (槽位掃描、液位確認)
│   │   ├── ManualOperation.vue # 手動操作介面
│   │   ├── NumberSelector.vue  # 數字選擇器元件
│   │   └── PipeSystem.vue      # 管路系統監控 (目前部分隱藏)
│   ├── electron/           # Electron 主進程邏輯
│   │   ├── entrypoint.js       # 後端邏輯入口 (初始化 GPIO, Interlock, IPC)
│   │   ├── interlock.js        # 安全與警報邏輯 (Interlock Class)
│   │   └── modules.js          # Modbus 通訊與硬體控制 (GPIO Class)
│   ├── plugins/            # Vue 插件 (如 vuetify.js)
│   ├── App.vue             # 前端主視圖 (Layout, Tab 導航, 狀態列)
│   ├── background.js       # Electron 程式進入點 (視窗建立)
│   └── main.js             # Vue 程式進入點
├── package.json            # 專案依賴與腳本設定
└── vue.config.js           # Vue CLI 與 Electron Builder 設定
```

---

## 3. 架構分析 (Architecture Analysis)

專案採用標準的 Electron **Main Process (主進程)** 與 **Renderer Process (渲染進程)** 分離架構。

### 3.1 Backend - Electron Main Process (後端)

後端負責與硬體 (PLC) 通訊、處理核心邏輯以及管理應用程式生命週期。

-   **進入點 (`src/background.js`)**:
    -   負責建立應用程式視窗 (`BrowserWindow`)。
    -   引入並執行 `src/electron/entrypoint.js` 中的 `mainFunction` 來啟動核心邏輯。

-   **核心邏輯 (`src/electron/entrypoint.js`)**:
    -   **初始化**: 建立 `winston` logger，實例化 `GPIO` 與 `Interlock` 物件。
    -   **IPC 處理**: 設定 `ipcMain.handle` 與 `ipcMain.on` 監聽器，接收前端指令（如 `main/get`, `mainFunction/action/...`）。
    -   **定期輪詢 (Polling)**: 使用 `setInterval` (100ms) 定期呼叫 `GPIO.Loop()` 更新感測器數據，並執行 `Interlock.Check()` 檢查異常。
    -   **主動推送**: 透過 `win.webContents.send` 將某些即時數據（如槽位更新）推送到前端。

-   **硬體通訊 (`src/electron/modules.js` - Class `GPIO`)**:
    -   **Modbus Client**: 使用 `jsmodbus` 建立 TCP 連線至 PLC。
    -   **數據編解碼**: 實作 `dwordEncoder` 與 `dwordDecoder` 處理 Modbus 暫存器的浮點數轉換 (32-bit Float Big Endian)。
    -   **感測器讀取 (`Loop`)**: 定期讀取 Holding Registers (數值) 與 Coils (狀態)，並更新內部的 `this.values` 物件。
    -   **設備控制**: 封裝各種動作指令（如 `ActionRobotMove2Slot`, `ActionLiquidPump`），寫入對應的 PLC 暫存器或線圈。
    -   **優化**: 實作 `ScanAllSlots` 進行批量讀取與 Diffing，減少不必要的 IPC 傳輸。

-   **安全機制 (`src/electron/interlock.js` - Class `Interlock`)**:
    -   **警報檢查**: 包含多個檢查函式（如 `checkEMO`, `checkDoorLock`, `checkLiquidLeak`）。
    -   **計時器邏輯**: 支援延遲觸發警報 (`checkAndUpdateTimer`)，避免訊號抖動造成誤報。
    -   **警報佇列**: 將偵測到的異常加入 `alerts` 佇列，供前端透過 IPC 查詢。

### 3.2 Frontend - Vue Renderer Process (前端)

前端負責顯示即時狀態、提供操作介面並傳送指令給後端。

-   **主介面 (`src/App.vue`)**:
    -   **佈局**: 使用 `<v-tabs>` 進行功能切換 (主要功能、管路系統、手動操作、事件回報)。
    -   **資訊列**: 顯示全域狀態（氟化液濃度、壓力、設備連線狀態）。
    -   **全域警報**: 透過 `eventBus` 監聽與顯示警報對話框 (`Monitor Logic`)。
    -   **定期更新**: 使用 `setInterval` (500ms) 呼叫 `ipcRenderer.invoke("main/get")` 同步後端數據。

-   **主要組件**:
    -   **MainFunction.vue**:
        -   使用 **SVG** 繪製視覺化的 TANK 與 MMS 槽位圖。
        -   透過計算屬性 (`computed`) 動態生成槽位座標。
        -   實作複雜的操作流程（如掃描槽位、置換流程），透過 Dialog 顯示步驟進度 (`pending` -> `process` -> `done/fail`)。

## 4. 關鍵流程 (Key Workflows)

### 4.1 系統啟動與連線
1.  Electron 啟動 `background.js` -> 呼叫 `entrypoint.js:mainFunction`。
2.  `GPIO` 嘗試連線 PLC。
3.  連線成功後，`Loop` 開始定期讀取數據。

### 4.2 數據更新循環
1.  **Backend**: `GPIO.Loop()` 每 100ms 讀取 PLC -> 更新 `GPIO.values`。
2.  **Logic**: `entrypoint.js` 呼叫 `Interlock.Check(values)` 偵測異常。
3.  **Frontend**: `App.vue` 每 500ms 透過 IPC `main/get` 獲取最新 `values` 並更新 UI。

### 4.3 使用者操作 (例：掃描槽位)
1.  使用者點擊 UI 按鈕 (`MainFunction.vue`)。
2.  前端呼叫 `ipcRenderer.invoke("mainFunction/action/robot/scanTankSlots")`。
3.  後端 `entrypoint.js` 收到請求，呼叫 `GPIO.ActionRobotScanTankSlots`。
4.  `GPIO` 寫入 PLC 暫存器觸發動作，並進入迴圈監控 PLC 執行狀態碼 (`206` register)。
5.  動作完成後回傳結果至前端，前端更新 UI 狀態。

## 5. 程式碼細節觀察

-   **日誌系統**: 使用 `winston` 記錄日誌，開發模式下輸出至專案目錄，生產模式下輸出至 `/home/user/...`，具備輪替 (Log Rotation) 功能。
-   **錯誤處理**: 大部分 API 請求都有 `try-catch` 包裹，防止通訊失敗導致程式崩潰。
-   **樣式**: 高度客製化的 CSS 與 SVG 排版，結合 Vuetify 元件，呈現現代化的工業儀表板風格。

此分析文件基於 2026/02/10 的程式碼版本進行整理。
